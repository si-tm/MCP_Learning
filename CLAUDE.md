# MCP Learning - プロジェクト運営ガイド

## プロジェクト概要

MCP（Model Context Protocol）学習用プロジェクト
- 段階的な学習のためのchapter構成
- chapter10: 最も発展した実装（Claude Code風対話型AIエージェント、172テスト）

## 開発環境・ツール

### パッケージ管理
- **uv**: 全ての依存関係管理とテスト実行に使用
  ```bash
  uv run pytest
  ```

### 必須環境
- Python 3.12以上
- pytest + pytest-asyncio + pytest-cov + pytest-xdist
- OpenAI API（LLM統合）

### 設定ファイル
- `config.yaml`: エージェント設定（LLM、実行、表示）
- `pyproject.toml`: プロジェクト依存関係
- `.env`: APIキー等の環境変数

## コーディング規約・原則

### 1. 実用性優先の原則
- **動作するコードは貴重な資産** - テストが通っているコードを軽視しない
- **「完璧」より「動作する」** - 形式的な改善のために実質を壊さない
- **段階的改善** - 大規模リファクタリングよりも小さく確実な改善
- **小さな問題に囚われない** - 全体の価値を見失わない

### 2. テスト駆動開発
- **テストファーストの変更** - 変更前に既存テストを確認
- **テストカバレッジの維持** - 新機能には必ずテストを追加
- **実行コマンド**: `uv run pytest`
- **テストの価値を重視** - 通過しているテストは設計の正しさの証明

### 3. 保守性重視
- **処理フローの明確さ > 形式的完璧さ**
- **行数は問題ではない** - 処理フローが明確であれば長いクラスも許容
- **過度な分離を避ける** - 無理な責務分離は逆に複雑化を招く
- **枝葉末節より本質** - 本質的な価値を重視

### 4. コードレビューの優先順位
1. **動作確認** - テスト結果が最優先
2. **構造理解** - 処理フローの明確さ
3. **実用性評価** - ユーザー価値
4. **形式的問題** - 動作に影響しない警告は最後

## プロジェクト構造ガイド

### ディレクトリ構成
```
MCP_Learning/
├── chapter01/          # 基礎学習
├── chapter03/          #
├── chapter05/          #
├── chapter06/          #
├── chapter07/          #
├── chapter08/          #
├── chapter09/          #
├── chapter10/          # 最も発展した実装（MCPエージェント）
│   ├── tests/          # 172個の包括的テスト
│   ├── mcp_agent.py    # メインエージェント
│   └── README.md       # 詳細ドキュメント
├── config.yaml         # グローバル設定
└── pyproject.toml      # プロジェクト依存関係
```

### ファイル命名規則
- **_v*.py ファイル**: 開発履歴保存用（不要になれば削除可）
- **chapter*_v* ディレクトリ**: 大きな変更の履歴（必要に応じて整理）
- **バージョンなしファイル**: 現在の最新版

### Chapter10の特徴
172テストを持つ包括的なMCPエージェント実装：
- ✅ ESC中断制御システム
- ✅ REPLコマンドシステム（/help, /status, /tools等）
- ✅ マルチモデル対応（GPT-4o-mini, GPT-5シリーズ）
- ✅ MCPサーバー統合（calculator, filesystem, database等）
- ✅ 完全リファクタリングされたアーキテクチャ

## 開発ワークフロー

### リファクタリング前のチェックリスト
1. ✅ 現在のテストは全て通っているか？
2. ✅ 処理フローは本当に複雑か？
3. ✅ 依存関係は本当に問題か？
4. ✅ リファクタリングの利益はリスクを上回るか？
5. ✅ 既存の設計に隠れた良さはないか？

### 新機能追加の流れ
1. 既存テストの確認（`uv run pytest`）
2. 新機能のテスト作成
3. 実装
4. テスト実行・修正
5. 統合テストで動作確認

### テスト実行
```bash
# 全テスト実行
uv run pytest

# 並列実行（高速）
uv run pytest -n auto

# カバレッジ付き
uv run pytest --cov

# 特定のテスト
uv run pytest tests/test_specific.py
```

### トラブルシューティング
- **テスト失敗時**: まず既存機能を壊していないか確認
- **依存関係エラー**: `uv lock` で依存関係を更新
- **設定問題**: `config.yaml` の形式とパラメータを確認
- **APIエラー**: `.env` ファイルのAPIキーを確認

## 学んだ教訓（参考）

### Chapter10での具体的な経験
- ✅ **適切な規模**: MCPAgent 638行は処理フローが明確なら許容範囲
- ✅ **段階的改善の成功**: エラー処理改善（Phase 1）は成功
- ⚠️ **過度な分離の失敗**: アーキテクチャ分離（Phase 2）は過剰だった
- ⚠️ **無理な責務分離**: RequestCoordinatorのような分離は複雑化を招いた
- ✅ **テストの価値**: 172個のテストが通るコードの価値を軽視しない

### 一般化された開発原則
- テストが通っているコードは貴重な資産
- 形式的な改善より実質的な動作
- 行数だけで「神クラス」と判断しない
- 完璧主義に陥らず実用性を優先
- 処理フローの明確さと保守性を重視

## 参考リソース

### Chapter10 ドキュメント
- `chapter10/README.md`: 機能詳細とアーキテクチャ
- `chapter10/AGENT.md`: エージェントの使い方
- `chapter10/tests/`: テストスイート（172テスト）

### 設定例
- `chapter10/config.yaml`: 推奨設定
- `chapter10/config.sample.yaml`: 設定テンプレート
